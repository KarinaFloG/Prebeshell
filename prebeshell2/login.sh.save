#!/bin/bash

#Variables para guardar la contrasenia y el password
usuario=""
contrasenia=""
#Variable para el control del programa
control=0
var=4
#Archivos en donde se encuentran los usuarios y contrasenias validos
#usuarios=~/usuarios.txt
#contrasenias=~/contrasenias.txt

#Para el control de las veces que se intenta acceder
while [ $control -lt 4 ]; do
	echo -e "\e[31m\e[43m Usuario: \e[0m\e[49m"
	read   usuario
	#Valida que la entrada del usuario no este vacia
	if [ -z $usuario ]; then
		echo -e "\e[30m\e[42m Este campo no puede estar vacio,intenta de nuevo \e[0m\e[49m"
		#Incrementa la variable de control para el ciclo while
		control=$((control+1))
		intentos=$((4 - control))
		echo -e  "\e[30m\e[46m Te quedan $intentos  intentos \e[0m\e[49m"
	else
		#El ciclo se encarga de revisar que el usuario que se ingreso exista en el sistema
		if [ $(sudo egrep -c  $usuario /etc/shadow | tail -n 1) -ne 0 ]; then
#		 if [ $(sudo egrep -w  $usuario /etc/password) -ne 0 ]; then

			#Si se encuentra en el sistema, se valida que este dentro de la lista de usuarios
			if [ $(egrep -w $usuario $usuarios) -ne 0 ]; then
				#Si se encuentra en ambas listas, solicita el password de acceso
				echo -e "\e[31m\e[42m Password: \e[0m\e[49m"
				read -s contrasenia
				#Verifica que el password ingresado no sea nulo, por seguridad
				if [ -z $contrasenia ]; then
					echo -e "\e[30m\e[42m Este campo no puede estar vacio, intenta de nuevo \e[0m\e[49m"
					#Incrementa la variable de control para el ciclo while
					control=$((control+1))
				else
					#Verifica que la contrase単a ingresada se encuentre en el sistema
					if [ $(egrep -w $contrasenia $contrasenias) -ne 0 ]; then
						echo -e "\e[32m\e[43m BIEVENIDO AL SISTEMA!! \e[0m\e[49m"
						#aqui va la prebeshell
					else
						#Manda error si la contrase単a es incorrecta
						echo -e "\e[30m\e[42m La contrasenia es incorrecta, intentalo de nuevo \e[0m\e[49m"
						#Incrementa la variable de control para el ciclo while
						control=$((control+1))
					fi
				fi
			else
				#Esta parte del codigo se encarga de meter a la lista de usuarios aquellos usuarios que ya fueron validados de que existen en el sistema
				#pero es la primera vez que entran y por lo tanto no existen en el archivo de usuarios 
				echo -e "\e[30m\e[43m  REPAMPANOS !! Parece que es la primera vez que usas esta belleza de prebeshell \e[0m\e[49m"
				echo -e "\e[30m\e[43m  Establece una contrasenia para tu sesion porfi \e[0m\e[49m"
				#Agrega al usuario al archivo que contiene a los usuarios del sistema (es un txt)
				(sudo egrep -o $usuario /etc/shadow | tail -n 1) >> $usuarios
				echo -e "\e[31m\e[42m Password: \e[0m\e[49m"
				read -s  contrasenia
				#Veridica que el password ingresado no sea nulo, por seguridad
				if [ -z $contrasenia ]; then
					echo -e "\e[30m\e[42m Este campo no puede ir vacio, intentalo de nuevo \e[0m\e[49m"
					#Incrementa la variable de control para el ciclo while
					control=$((control+1))
				else
					#Agrega la contrase単a del usuario a la lista de contrase単as (es un txt)
					echo "$contrasenia" >> $contrasenias
					control=4
					##AQUI VA LA PRECIOSA PREBESHELL
				fi
			fi
		else #else 2
			echo -e "\e[30m\e[42m El usuario no se encuentra en el sistema, intentalo de nuevo con otro usuario \e[0m\e[49m"
			control=$((control+1))
		fi # fi 2
	fi #fi 1



done
